<!DOCTYPE html>
<html>
	<head>
		<!--Import Google Icon Font-->
		<link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<!--Import materialize.css-->
		<link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<style>
			body {
				transform: translate3d(0,0,0);
			}
		</style>
	</head>
	<body style="overflow-y:hidden; overflow-x:hidden; background-image:url(images/stripes.gif); background-repeat:repeat; ">
		<!--Import jQuery before materialize.js-->
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="js/materialize.min.js"></script>

		<!-- Import MIDI.js -->
		<script src="js/midi/inc/shim/Base64.js" type="text/javascript"></script>
		<script src="js/midi/inc/shim/Base64binary.js" type="text/javascript"></script>
		<script src="js/midi/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
		<!-- midi.js package -->
		<script src="js/midi/midi/audioDetect.js" type="text/javascript"></script>
		<script src="js/midi/midi/gm.js" type="text/javascript"></script>
		<script src="js/midi/midi/loader.js" type="text/javascript"></script>
		<script src="js/midi/midi/plugin.audiotag.js" type="text/javascript"></script>
		<script src="js/midi/midi/plugin.webaudio.js" type="text/javascript"></script>
		<script src="js/midi/midi/plugin.webmidi.js" type="text/javascript"></script>
		<!-- utils -->
		<script src="js/midi/util/dom_request_xhr.js" type="text/javascript"></script>
		<script src="js/midi/util/dom_request_script.js" type="text/javascript"></script>
		<!-- soundfront -->

		<script src="soundfont/acoustic_grand_piano-mp3.js"></script>

		<script src="itty_bitty_ditty_synth_library_front_end/multithread.js"></script>

		<script src="js/modexpression.js"></script>

		<!-- *********************** BEGIN ADD CHUNK *********************** -->
		<!-- Below is the WebWorker segment of the timer. -->
        <script id="timerScript">
        Function.prototype.interval = function (ms) {
            var func = this;
            function interval() {
                var obj = this, args = arguments, nextInterval=now()+ms;
                func.apply(obj, args);
                setTimeout(function(){interval.apply(obj, args);},nextInterval-now());
            }
            return interval;
        }

        function now(){return (new Date()).getTime()};
        var interval=10,
            start=now();
        (function(){
            var elapsed=now()-start;
            self.postMessage(elapsed);
        }.interval(interval)())
        </script>
		<!-- ************************ END ADD CHUNK ************************ -->

		<script src="js/canvasplayer_mt.js"></script>

		<script src="js/preferences.js"></script>

		<!-- Covers for Loading -->
		<div style="position:absolute; width:100%; height:100%; left:0px; top:0px" id="loadingCover1">
			<table style="position:absolute; left:0px; top:0px; background-color:white" height="100%" width="100%" valign="center">
				<tr>
					<td>
						<center>
							<img src="images/wait.png" width="32px" height="32px" />
							<br />
						</center>
						<div style="font-family:Arial, Arial, serif; font-size:14px; padding:6px">
							<center>Loading canvases </center>
						</div>
						<div style="font-family:Arial, Arial, serif; font-size:13px; padding:6px">
							<br />
							<center> <div class="progress" style="width:25%">
								<div class="indeterminate"></div>
							</div></center>
							<br />
						</div>
					</td>
				</tr>
			</table>
		</div>
		<div style="position:absolute; width:100%; height:100%; left:0px; top:0px" id="loadingCover2">
			<table style="position:absolute; left:0px; top:0px; background-color:white" height="100%" width="100%" valign="center">
				<tr>
					<td>
						<center>
							<img src="images/wait.png" width="32px" height="32px" />
							<br />
						</center>
						<div style="font-family:Arial, Arial, serif; font-size:14px; padding:6px">
							<center>Loading canvases </center>
						</div>
						<div style="font-family:Arial, Arial, serif; font-size:13px; padding:6px">
							<br />
							<center> <div class="progress" style="width:25%">
								<div class="indeterminate"></div>
							</div></center>
							<br />
						</div>
					</td>
				</tr>
			</table>
		</div>
		<div style="position:absolute; width:100%; height:100%; left:0px; top:0px" id="loadingCover3">
			<table style="position:absolute; left:0px; top:0px; background-color:white" height="100%" width="100%" valign="center">
				<tr>
					<td>
						<center>
							<img src="images/wait.png" width="32px" height="32px" />
							<br />
						</center>
						<div style="font-family:Arial, Arial, serif; font-size:14px; padding:6px">
							<center>Loading canvases </center>
						</div>
						<div style="font-family:Arial, Arial, serif; font-size:13px; padding:6px">
							<br />
							<center> <div class="progress" style="width:25%">
								<div class="indeterminate"></div>
							</div></center>
							<br />
						</div>
					</td>
				</tr>
			</table>
		</div>
		<div style="position:absolute; width:100%; height:100%; left:0px; top:0px" id="loadingCover4">
			<table style="position:absolute; left:0px; top:0px; background-color:white" height="100%" width="100%" valign="center">
				<tr>
					<td>
						<center>
							<img src="images/wait.png" width="32px" height="32px" />
							<br />
						</center>
						<div style="font-family:Arial, Arial, serif; font-size:14px; padding:6px">
							<center>Loading canvases </center>
						</div>
						<div style="font-family:Arial, Arial, serif; font-size:13px; padding:6px">
							<br />
							<center> <div class="progress" style="width:25%">
								<div class="indeterminate"></div>
							</div></center>
							<br />
						</div>
					</td>
				</tr>
			</table>
		</div>
		<div style="position:absolute; width:100%; height:100%; left:0px; top:0px" id="loadingCover5">
			<table style="position:absolute; left:0px; top:0px; background-color:white" height="100%" width="100%" valign="center">
				<tr>
					<td>
						<center>
							<img src="images/wait.png" width="32px" height="32px" />
							<br />
						</center>
						<div style="font-family:Arial, Arial, serif; font-size:14px; padding:6px">
							<center>Loading canvases </center>
						</div>
						<div style="font-family:Arial, Arial, serif; font-size:13px; padding:6px">
							<br />
							<center> <div class="progress" style="width:25%">
								<div class="indeterminate"></div>
							</div></center>
							<br />
						</div>
					</td>
				</tr>
			</table>
		</div>

		<!-- Large Container -->
		<div id="container" style="background-image:url(images/stripes.gif); background-repeat:repeat; width:100%; height:100%">
			<table style="font-family:Arial, Arial, serif; font-size: 32px; color:#FFFFFF; padding:0px; border:0px; border-spacing:0px; ">
				<!-- Chunk for Timeline -->
				<tr style="height:96px ; max-height:96px; ">
					<td style="max-height:96px; max-width:48px; background-color:#00FFFF; height:96px; width:48px; padding:0px; ">
						<center>1</center>
					</td>
					<td style="display:block; max-height:96px;  height:96px; color:#000000; vertical-align: center; padding:0px; ">
						<div style="height:96px; max-height:96px;  overflow:hidden">
							<iframe style="border:0px; width:100%; height:96px" src="timelineview_cvstimeline.html?canvasn=1"></iframe>
						</div>
					</td>
				</tr>

				<!-- Chunk for Timeline -->
				<tr style="height:96px ; max-height:96px; ">
					<td style="max-height:96px; max-width:48px; background-color:#7FFF00; height:96px; width:48px; padding:0px; ">
						<center>2</center>
					</td>
					<td style="display:block; max-height:96px;  height:96px; color:#000000; vertical-align: center; padding:0px; ">
						<div style="height:96px; max-height:96px;  overflow:hidden">
							<iframe style="border:0px; width:100%; height:96px" src="timelineview_cvstimeline.html?canvasn=2"></iframe>
						</div>
					</td>
				</tr>

				<!-- Chunk for Timeline -->
				<tr style="height:96px ; max-height:96px; ">
					<td style="max-height:96px; max-width:48px; background-color:#DC143C; height:96px; width:48px; padding:0px; ">
						<center>3</center>
					</td>
					<td style="display:block; max-height:96px;  height:96px; color:#000000; vertical-align: center; padding:0px; ">
						<div style="height:96px; max-height:96px;  overflow:hidden">
							<iframe style="border:0px; width:100%; height:96px" src="timelineview_cvstimeline.html?canvasn=3"></iframe>
						</div>
					</td>
				</tr>

				<!-- Chunk for Timeline -->
				<tr style="height:96px ; max-height:96px; ">
					<td style="max-height:96px; max-width:48px; background-color:#FF8C00; height:96px; width:48px; padding:0px; ">
						<center>4</center>
					</td>
					<td style="display:block; max-height:96px;  height:96px; color:#000000; vertical-align: center; padding:0px; ">
						<div style="height:96px; max-height:96px;  overflow:hidden">
							<iframe style="border:0px; width:100%; height:96px" src="timelineview_cvstimeline.html?canvasn=4"></iframe>
						</div>
					</td>
				</tr>

				<!-- Chunk for Timeline -->
				<tr style="height:96px ; max-height:96px; ">
					<td style="max-height:96px; max-width:48px; background-color:#483D8B; height:96px; width:48px; padding:0px; ">
						<center>5</center>
					</td>
					<td style="display:block; max-height:96px;  height:96px; color:#000000; vertical-align: center; padding:0px; ">
						<div style="height:96px; max-height:96px;  overflow:hidden">
							<iframe style="border:0px; width:100%; height:96px" src="timelineview_cvstimeline.html?canvasn=5"></iframe>
						</div>
					</td>
				</tr>

				<!-- Chunk for Timeline -->
				<tr style="font-size: 26px; height:96px ; max-height:96px; ">
					<td style="max-height:96px; max-width:48px; background-color:#808080; height:96px; width:48px; padding:0px; ">
						<center>e1</center>
					</td>
					<td style="display:block; max-height:96px;  height:96px; color:#000000; vertical-align: center; padding:0px; ">
						<div style="height:96px; max-height:96px;  overflow:hidden">
							<iframe style="border:0px; width:100%; height:96px" src="timelineview_cvstimeline.html?canvasn=ext1"></iframe>
						</div>
					</td>
				</tr>

				<!-- Chunk for Timeline -->
				<tr style="font-size: 26px; height:96px ; max-height:96px; ">
					<td style="max-height:96px; max-width:48px; background-color:#808080; height:96px; width:48px; padding:0px; ">
						<center>e2</center>
					</td>
					<td style="display:block; max-height:96px;  height:96px; color:#000000; vertical-align: center; padding:0px; ">
						<div style="height:96px; max-height:96px;  overflow:hidden">
							<iframe style="border:0px; width:100%; height:96px" src="timelineview_cvstimeline.html?canvasn=ext2"></iframe>
						</div>
					</td>
				</tr>

				<!-- Chunk for Timeline -->
				<tr style="font-size: 26px; height:96px ; max-height:96px; ">
					<td style="max-height:96px; max-width:48px; background-color:#808080; height:96px; width:48px; padding:0px; ">
						<center>e3</center>
					</td>
					<td style="display:block; max-height:96px;  height:96px; color:#000000; vertical-align: center; padding:0px; ">
						<div style="height:96px; max-height:96px;  overflow:hidden">
							<iframe style="border:0px; width:100%; height:96px" src="timelineview_cvstimeline.html?canvasn=ext3"></iframe>
						</div>
					</td>
				</tr>

				<tr style="height:96px"></tr>
			</table>
		</div>

		<!-- Floating Action Button -->
		<div id="FAB" class="fixed-action-btn horizontal click-to-toggle" style="position: fixed; bottom: 45px; right: 24px;">
			<a id="FAButton" onclick="togglePlayBack(); " class="btn-floating btn-large red" data-position="top" data-delay="50" data-tooltip="Toggle playback">
			<i class="large material-icons">play_arrow</i>
			</a>
		</div>

		<script src="js/timeline.js"></script>
		<script>
			// Script to handle playback start/stop by the FAB
			var isPlaying = false;
			localStorage.setItem("bitty.synth.isPlaying", isPlaying);
			var canvases = [];

			// i: the index of the timeline definition.
			function loadFileToArray(i) {
				var ret = [];
				// Get file.
				var fString = "";
				fString = localStorage.getItem("bitty.synth.timelinecvs" + i);
				if (fString==null || fString=="") return ret;
				// Put file into array form.
				var fArray = fString.split(",");
				// Remove the last empty item.
				fArray.pop();
				// Return the array.
				return fArray;
			}

			// ***********************************************************************
			// ***********************************************************************

			var cvsAudio = [];
			cvsAudio[1] = new canvasplayback(1);
			cvsAudio[2] = new canvasplayback(2);
			cvsAudio[3] = new canvasplayback(3);
			cvsAudio[4] = new canvasplayback(4);
			cvsAudio[5] = new canvasplayback(5);

			// Load external audio tracks.
			try {
			    cvsAudio[6] = new Audio();
			    cvsAudio[6].onerror = function() {
			        //Materialize.toast("Error loading external audio 1", 3000);
			    };
			    if (localStorage.getItem("bitty.synth.ext1")!=null && localStorage.getItem("bitty.synth.ext1")!="" && localStorage.getItem("bitty.synth.ext1")!=undefined){
			        cvsAudio[6].src = localStorage.getItem("bitty.synth.ext1");
			        console.log("Loaded ext audio 1. ");
			    }
			} catch (err) {
				//Materialize.toast("Error loading external audio 1", 3000);
			}

			try {
			    cvsAudio[7] = new Audio();
			    cvsAudio[7].onerror = function() {
			        //Materialize.toast("Error loading external audio 2", 3000);
			    };
			    if (localStorage.getItem("bitty.synth.ext2")!=null && localStorage.getItem("bitty.synth.ext2")!="" && localStorage.getItem("bitty.synth.ext2")!=undefined){
			        cvsAudio[7].src = localStorage.getItem("bitty.synth.ext2");
			        console.log("Loaded ext audio 2. ");
			    }
			} catch (err) {
				//Materialize.toast("Error loading external audio 2", 3000);
			}

			try {
			    cvsAudio[8] = new Audio();
			    cvsAudio[8].onerror = function() {
			        //Materialize.toast("Error loading external audio 3", 3000);
			    };
			    if (localStorage.getItem("bitty.synth.ext3")!=null && localStorage.getItem("bitty.synth.ext3")!="" && localStorage.getItem("bitty.synth.ext3")!=undefined){
			        cvsAudio[8].src = localStorage.getItem("bitty.synth.ext3");
			        console.log("Loaded ext audio 3. ");
			    }
			} catch (err) {
				//Materialize.toast("Error loading external audio 3", 3000);
			}

			// ***********************************************************************
			// ***********************************************************************

			function togglePlayBack(){
				isPlaying = !isPlaying;
				// The function nextFramePlay(i) checks isPlaying to see if it must schedule next playback.
				Materialize.toast("Playback toggled. ", 2000);
				if (isPlaying) nextFramePlay(0);
				localStorage.setItem("bitty.synth.isPlaying", isPlaying);
			}

			function nextFramePlay(i) {
				console.log("nextFramePlay: " + i)
				// Load all timelines
				var cvsTmls = [];
				cvsTmls[1] = loadFileToArray(1);
				cvsTmls[2] = loadFileToArray(2);
				cvsTmls[3] = loadFileToArray(3);
				cvsTmls[4] = loadFileToArray(4);
				cvsTmls[5] = loadFileToArray(5);
				cvsTmls[6] = loadFileToArray("ext1");
				cvsTmls[7] = loadFileToArray("ext2");
				cvsTmls[8] = loadFileToArray("ext3");

				// Check if at end of timeline or if all else is empty.
				// Search thru all timeline arrays. If they only contain number lower
				// than i, then return.
				var hasMore = false;
				for (var ci = 1; ci < cvsTmls.length; ci++) {
					for (var cj = 0; cj < cvsTmls[ci].length; cj++) {
						if ((parseInt(cvsTmls[ci][cj]) + parseInt(cvsAudio[ci].duration()) * 4 + 1) >= i) hasMore = true;
					}
				}
				if (!hasMore) {
					isPlaying = false;
					localStorage.setItem("bitty.synth.isPlaying", isPlaying);
					return;
				}

				// Play anything at current time.
				// Seach thru all timeline arrays. If i = Array[j], then play the corres
				// ponding array's contents.
				for (var ci = 1; ci < cvsTmls.length; ci++) {
					for (var cj = 0; cj < cvsTmls[ci].length; cj++) {
						if (parseInt(cvsTmls[ci][cj]) == i) {
							// Play the thing back.
							cvsAudio[ci].play();
							console.log("Play: " + ci + " at time " + i)
						}
					}
				}

				// Schedule next.
				if (isPlaying) {
					setTimeout(function(){nextFramePlay(i+1)}, 250);
				} else {
					// Stop all playback.
					for (var ci = 1; ci < cvsTmls.length; ci++){
						//if (!cvsAudio[ci]==undefined) {
							try {
								cvsAudio[ci].pause();
							} catch (err) {

							}
							cvsAudio[ci].src = cvsAudio[ci].src;
						//}
					}
				}
			}
		</script>
		<script>
			// Script to enable tooltips on desktop platforms
			if (window.navigator.userAgent.indexOf("Android") != -1 || window.navigator.userAgent.indexOf("iPhone") != -1 || window.navigator.userAgent.indexOf("iPad") != -1)
				console.log("Mobile Platform Detected");
			else {
				console.log("Desktop Platform Detected");
				FAButton.className += " tooltipped";
			}
		</script>
	</body>
</html>
